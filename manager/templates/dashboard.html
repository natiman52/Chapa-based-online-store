{%extends "Mcomponent/manager_base.html" %}
{% load store %}
{%block stuff%}
<style>
    .text-silver {
        color: #a8a8a8;
    }

    .radient {
        background-color: rgb(192, 255, 192);
    }

    .dimmed {
        background-color: rgb(255, 198, 198);
    }
</style>
<div class="mx-4 mt-3 ">
    <div class=" pb-1 mb-2">
        <span class="bg-white px-1 rounded-pill">
            <a href="{%url 'adminhome' %}">/</a>
        </span>
        <p class="mb-0">Dashboard</p>
    </div>
    <div style="row-gap: 1rem;column-gap: 3rem;" class="d-flex flex-wrap mb-5">
        <div class="col-lg-3 bg-white col-md-4 col-12 text-dark py-2 px-4 rounded">
            <div class="d-flex gap-5 align-items-center justify-content-between">
                <div class="d-flex  flex-column">
                    <p class="mb-0  fs-6 text-silver">New orders</p>
                    <p class="mb-0"><span class="fs-4 mb-0 fw-bold">{%if orders.total.count %}{{orders.total.count}}
                            {%else%}0{%endif%}</span>
                        {%if orders.growth > 0%}
                        <span class="radient badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-up"></i>
                            {{orders.percentage_diff}} %</span>
                        {%else%}
                        <span class="dimmed badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-down"></i>
                            {{orders.percentage_diff}} %</span>
                        {%endif%}
                    </p>
                </div>
                <div class="rounded" style="background-color: rgb(255, 195, 195);">
                    <i class="p-2  fs-4 fas fa-chart-bar"></i>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-4 col-12 bg-white text-dark py-2 px-4 rounded">
            <div class="d-flex gap-5 align-items-center justify-content-between">
                <div class="d-flex flex-column">
                    <p class="mb-0 fs-6 text-silver">Product</p>
                    <p class="mb-0"><span class="fs-4 mb-0 fw-bold">{%if products.total.count %}{{products.total.count}}
                            {%else%}0{%endif%}</span>
                        {%if products.growth > 0%}
                        <span class="radient badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-up"></i>
                            {{products.percentage_diff}} %</span>
                        {%else%}
                        <span class="dimmed badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-down"></i>
                            {{products.percentage_diff}} %</span>
                        {%endif%}
                    </p>
                </div>
                <div class="rounded" style="background-color: rgb(255, 255, 195);">
                    <i class="p-2 rounded fs-4 fa fa-th-large"></i>
                </div>
            </div>
        </div>

        <div class="col-lg-3 bg-white col-md-4 col-12 text-dark py-2 px-4 rounded">
            <div class="d-flex gap-5 align-items-center justify-content-between">
                <div class="d-flex flex-column">
                    <p class="mb-0  fs-6 text-silver">Users</p>
                    <p class="mb-0"><span class="fs-4 mb-0 fw-bold">{%if users.total.count %}{{users.total.count}}
                            {%else%}0{%endif%}</span>
                        {%if users.growth > 0%}
                        <span class="radient badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-up"></i>
                            {{usesrs.percentage_diff}} %</span>
                        {%else%}
                        <span class="dimmed badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-down"></i>
                            {{users.percentage_diff}} %</span>
                        {%endif%}
                    </p>
                </div>
                <div class="rounded" style="background-color: rgb(222, 255, 222);">
                    <i class="p-2 fs-4 fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>
    <div style="row-gap: 2rem;" class="row mb-4">
        <div class="col-12 col-md-8 col-lg-8">
            <!-- Sales Chart -->
            <div class="shadow-sm bg-white p-4 mb-4 rounded">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <p class="h4">Sales Overview (Last 30 Days)</p>
                    <div>
                        {% if graph_trend_percentage > 0 %}
                            <span class="radient badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-up"></i> {{ graph_trend_percentage }}%</span>
                        {% elif graph_trend_percentage < 0 %}
                            <span class="dimmed badge bg-gradient text-dark px-2 py-1"><i class="fas fa-arrow-down"></i> {{ graph_trend_percentage | multibyone }}%</span>
                        {% else %}
                            <span class="badge bg-light text-dark px-2 py-1">0%</span>
                        {% endif %}
                    </div>
                </div>
                <canvas id="salesChart" style="width:100%; height: 400px;"></canvas>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const ctx = document.getElementById('salesChart').getContext('2d');
                    const labels = {{ chart_labels| safe}};
                    const data = {{ chart_values| safe }};
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                data: data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            plugins:{
                                legend: {
                                    display: false
                                },
                            }
                    }
                    });
                    });
                </script>
            </div>

            <!-- Recent Orders -->
            <div class="shadow-sm bg-white p-4 rounded">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="text-dark fw-bold mb-0">Recent Orders</h5>
                    <a href="{% url 'orders' %}" class="btn btn-sm btn-light border text-primary fw-bold">View All</a>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="py-3 ps-3 border-0">Product</th>
                                <th class="py-3 border-0">Date</th>
                                <th class="py-3 border-0">Total</th>
                                <th class="py-3 border-0 text-end pe-3">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td class="ps-3 py-3">
                                    <div class="d-flex align-items-center">
                                        {% if order.product.images.first %}
                                        <img src="{{ order.product.images.first.img.url }}" alt="{{ order.product.name }}" class="rounded me-3" style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                        <div class="rounded me-3 bg-light d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="fas fa-box text-secondary"></i>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <h6 class="mb-0 text-dark small fw-bold">{{ order.product.name }}</h6>
                                            <small class="text-muted">{{ order.quantity }} items</small>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-3 text-muted small">
                                    {{ order.date|date:"M d" }}
                                </td>
                                <td class="py-3 text-dark small fw-bold">
                                    ETB {{ order.total_price|floatformat:2 }}
                                </td>
                                <td class="py-3 text-end pe-3">
                                    {% if order.status == 'success' %}
                                    <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3">Success</span>
                                    {% elif order.status == 'pending' %}
                                    <span class="badge bg-warning-subtle text-warning border border-warning-subtle rounded-pill px-3">Pending</span>
                                    {% else %}
                                    <span class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill px-3">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">
                                    No recent orders found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4 col-lg-4 px-0 px-lg-3">
            <div class="bg-white p-4 shadow-sm rounded mb-4 ">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <h5 class="text-silver mb-0">Total Revenue</h5>
                    <div class="rounded p-2" style="background-color: rgb(220, 255, 220);">
                        <i class="fas fa-wallet text-success fs-4"></i>
                    </div>
                </div>
                <h2 class="fw-bold mb-3">{{ total_revenue }} ETB</h2>
                
                <div class="d-flex align-items-center">
                    {% if revenue_growth > 0 %}
                        <span class="radient badge bg-gradient text-dark px-2 py-1 me-2">
                            <i class="fas fa-arrow-up"></i> {{ revenue_growth }} ETB
                        </span>
                        <span class="text-muted small">since last month</span>
                    {% else %}
                        <span class="dimmed badge bg-gradient text-dark px-2 py-1 me-2">
                            <i class="fas fa-arrow-down"></i> {{ revenue_growth|multibyone }} ETB
                        </span>
                        <span class="text-muted small">since last month</span>
                    {% endif %}
                </div>
            </div>

            <div class="bg-white w-100 p-4 shadow-sm rounded">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="text-silver mb-0">Most Popular Product</h5>
                    <div class="rounded p-2" style="background-color: rgb(255, 240, 220);">
                        <i class="fas fa-crown text-warning fs-4"></i>
                    </div>
                </div>
                {% if popular_products %}
                    {%for i in popular_products%}
                    <div class=" d-flex align-items-center">
                        {% if i.product.images.first %}
                            <img src="{{ i.product.images.first.img.url }}" alt="{{ i.product.name }}" class="rounded me-3" style="width: 60px; height: 60px; object-fit: cover;">
                        {% else %}
                             <div class="rounded me-3 bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                <i class="fas fa-box text-secondary"></i>
                             </div>
                        {% endif %}
                        <div>
                            <h6 class="fw-bold mb-1">{{ i.product.name }}</h6>
                            <p class="text-muted mb-0 small">{{ i.quantity }} sales</p>
                        </div>
                    </div>
                    {%endfor%}
                {% else %}
                    <p class="text-muted mb-0">No sales yet.</p>
                {% endif %}
                
            </div>
        </div>
    </div>
</div>
{%endblock%}